@page "/"
@using FinDashers.UI.Services
@using FinDashers.Core.Models
@inject NL2SQLApiClient ApiClient
@inject IJSRuntime JSRuntime

<PageTitle>FinDashers</PageTitle>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #fafafa;
    }
    
    .search-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 80vh;
        padding: 20px;
    }
    
    .logo {
        font-size: 48px;
        font-weight: 300;
        color: #4285f4;
        margin-bottom: 30px;
        letter-spacing: -1px;
    }
    
    .search-box {
        width: 100%;
        max-width: 584px;
        position: relative;
        margin-bottom: 30px;
    }
    
    .search-input {
        width: 100%;
        height: 44px;
        padding: 0 16px;
        border: 1px solid #dfe1e5;
        border-radius: 24px;
        font-size: 16px;
        outline: none;
        box-shadow: none;
        transition: box-shadow 0.2s;
    }
    
    .search-input:focus {
        border-color: #4285f4;
        box-shadow: 0 2px 5px 1px rgba(66,133,244,.3);
    }
    
    .search-button {
        background-color: #f8f9fa;
        border: 1px solid #f8f9fa;
        border-radius: 4px;
        color: #3c4043;
        font-size: 14px;
        margin: 11px 4px;
        padding: 0 20px;
        height: 36px;
        min-width: 54px;
        cursor: pointer;
        transition: box-shadow 0.2s;
    }
    
    .search-button:hover {
        box-shadow: 0 1px 1px rgba(0,0,0,.1);
        background-color: #f1f3f4;
        border: 1px solid #dadce0;
    }
    
    .search-button:disabled {
        background-color: #f8f9fa;
        border: 1px solid #f8f9fa;
        color: #80868b;
        cursor: not-allowed;
    }
    
    .results-container {
        width: 100%;
        max-width: 800px;
        margin-top: 20px;
    }
    
    .result-item {
        background: white;
        border-radius: 8px;
        margin-bottom: 16px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
</style>

<div class="search-container">
    <div class="logo">FinDashers</div>
    
    <div class="search-box">
        <input @bind="searchQuery" 
               @bind:event="oninput"
               @onkeypress="HandleKeyPress" 
               class="search-input" 
               placeholder="Ask about your payment data..." 
               type="text" />
    </div>
    
    <div>
        <button @onclick="SearchAsync" 
                disabled="@isLoading" 
                class="search-button">
            @if (isLoading)
            {
                <span>Searching...</span>
            }
            else
            {
                <span>Search</span>
            }
        </button>
    </div>

    
    @if (queryResult != null)
    {
        <div class="results-container">
            @if (queryResult.Success)
            {
                <div class="result-item">
                    <h3>Query Results</h3>
                    @if (queryResult.Data?.Any() == true)
                    {
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    @foreach (var column in queryResult.Data.First().Keys)
                                    {
                                        <th>@column</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var row in queryResult.Data)
                                {
                                    <tr>
                                        @foreach (var value in row.Values)
                                        {
                                            <td>@value</td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>No results found.</p>
                    }
                </div>
            }
            else
            {
                <div class="result-item">
                    <h3>Error</h3>
                    <p style="color: red;">@queryResult.Error</p>
                </div>
            }
        </div>
    }
</div>

@code {
    private string searchQuery = "";
    private bool isLoading = false;
    private QueryResponse? queryResult = null;

    private async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return;

        isLoading = true;
        queryResult = null;
        StateHasChanged();

        try
        {
            queryResult = await ApiClient.ProcessQueryAsync(searchQuery);
        }
        catch (Exception ex)
        {
            queryResult = new QueryResponse 
            { 
                Success = false, 
                Error = $"Connection error: {ex.Message}" 
            };
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(searchQuery) && !isLoading)
        {
            await SearchAsync();
        }
    }
}
