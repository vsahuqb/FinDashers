<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Payment Analytics Dashboard</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
    }
    .header h1 {
        font-size: 2.5rem;
        font-weight: 300;
        margin-bottom: 10px;
    }
    .ai-controls {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
        align-items: center;
    }
    .control-group {
        text-align: center;
    }
    .control-group label {
        color: white;
        display: block;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    input, select, button {
        padding: 8px 15px;
        border: none;
        border-radius: 20px;
        font-size: 14px;
        width: 100%;
    }
    button {
        background: #4facfe;
        color: white;
        cursor: pointer;
        font-weight: bold;
    }
    button:hover {
        background: #00f2fe;
    }
    .ai-insights {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        color: white;
    }
    .insight-item {
        background: rgba(255,255,255,0.1);
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
    }
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .status-live { background: #4CAF50; }
    .status-warning { background: #FF9800; }
    .status-error { background: #F44336; }
    .section {
        margin-bottom: 40px;
    }
    .section h2 {
        color: white;
        font-size: 1.8rem;
        margin-bottom: 20px;
        text-align: center;
    }
    .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-bottom: 40px;
    }
    .chart {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 1px 4px rgba(0,0,0,0.1);
        min-height: 300px;
    }
    .kpi-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0px 1px 4px rgba(0,0,0,0.1);
        margin-bottom: 40px;
    }
    .kpi-main {
        text-align: center;
        margin-bottom: 20px;
    }
    .kpi-main h2 {
        font-size: 3rem;
        margin-bottom: 5px;
    }
    .kpi-main p {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    .kpi-metrics {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
    }
    .kpi-metric {
        text-align: center;
        background: rgba(255,255,255,0.2);
        padding: 15px;
        border-radius: 10px;
    }
    .kpi-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .kpi-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>
</head>
<body>

<div class="header">
    <h1>AI Payment Analytics Dashboard</h1>
    <p>Real-time Intelligent Payment Monitoring</p>
</div>

<div class="ai-controls">
    <div class="control-group">
        <label>Start Date</label>
        <input type="date" id="startDate" value="2000-01-10">
    </div>
    <div class="control-group">
        <label>End Date</label>
        <input type="date" id="endDate" value="2026-12-10">
    </div>
    <div class="control-group">
        <label>Location (Optional)</label>
        <input type="text" id="locationId" placeholder="e.g. 115" value="115">
    </div>
</div>

<div style="text-align: center; margin-bottom: 20px;">
    <button id="loadDashboard" style="padding: 12px 30px; background: #4facfe; color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; font-weight: bold;">Load Dashboard Data</button>
</div>

<div class="ai-insights" id="aiInsights">
    <h3>AI Insights</h3>
    <div id="insightsList">
        <div class="insight-item">
            <span class="status-indicator status-live"></span>
            AI Agent Ready - Upload data or configure data source to begin analysis
        </div>
    </div>
</div>

<div class="section">
    <div id="kpiCard" class="kpi-card"></div>
</div>

<div class="section">
    <h2>Payment Health Heat Index</h2>
    <div id="heatIndexCard" class="kpi-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);"></div>
</div>

<div class="section">
    <h2>Transaction Flow Analysis</h2>
    <div class="container">
        <div id="funnelChart" class="chart"></div>
        <div id="successTrend" class="chart"></div>
    </div>
</div>

<div class="section">
    <h2>Performance Breakdown</h2>
    <div class="container">
        <div id="paymentMethodChart" class="chart"></div>
        <div id="locationHeatmap" class="chart"></div>
    </div>
</div>

<script>
class DashboardManager {
    constructor() {
        this.apiBaseUrl = 'http://localhost:5144/api/Dashboard';
        this.currentData = null;
        this.insights = [];
        this.initializeControls();
        this.setDefaultDates();
    }

    setDefaultDates() {
        document.getElementById('startDate').value = '2000-01-10';
        document.getElementById('endDate').value = '2026-12-10';
    }

    initializeControls() {
        document.getElementById('loadDashboard').addEventListener('click', () => {
            this.loadDashboardData();
        });
        
        // Auto-load on page load
        this.loadDashboardData();
    }

    async loadDashboardData() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const locationId = document.getElementById('locationId').value;
        
        if (!startDate || !endDate) {
            this.addInsight('‚ùå Please select start and end dates', 'error');
            return;
        }
        
        this.addInsight('üîÑ Loading dashboard data...', 'live');
        
        try {
            let url = `${this.apiBaseUrl}?StartDate=${startDate}&EndDate=${endDate}`;
            if (locationId) {
                url += `&LocationId=${locationId}`;
            }
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            this.currentData = data;
            
            this.updateDashboard(data);
            this.addInsight('‚úÖ Dashboard updated successfully', 'live');
            
        } catch (error) {
            this.addInsight(`‚ùå Error loading data: ${error.message}`, 'error');
            console.error('Dashboard API Error:', error);
        }
    }

    updateDashboard(data) {
        if (!data) return;
        
        // Update KPI Card with Payment Success Rate
        this.generateKPICard(data.paymentSuccessRate);
        
        // Update Heat Index Card
        this.generateHeatIndexCard(data.paymentHealthHeatIndex);
        
        // Generate charts with new data
        this.generateFunnelChart(data.paymentSuccessRate.funnelMetrics);
        this.generateHourlyTrend(data.paymentSuccessRate.hourlyTrends);
        this.generatePaymentMethodChart(data.paymentSuccessRate.paymentMethodRates);
        this.generateLocationHeatmap(data.paymentSuccessRate.locationRates);
        
        // Analyze heat index for insights
        this.analyzeHeatIndex(data.paymentHealthHeatIndex);
    }

    generateKPICard(successRateData) {
        document.getElementById('kpiCard').innerHTML = `
            <div class="kpi-main">
                <h2>${successRateData.dailySuccessRate.toFixed(1)}%</h2>
                <p>Payment Success Rate</p>
            </div>
            <div class="kpi-metrics">
                <div class="kpi-metric">
                    <div class="kpi-value">${successRateData.approvedCount.toLocaleString()}</div>
                    <div class="kpi-label">Approved</div>
                </div>
                <div class="kpi-metric">
                    <div class="kpi-value">${successRateData.declinedCount.toLocaleString()}</div>
                    <div class="kpi-label">Declined</div>
                </div>
                <div class="kpi-metric">
                    <div class="kpi-value">$${successRateData.netSales.toLocaleString()}</div>
                    <div class="kpi-label">Net Sales</div>
                </div>
                <div class="kpi-metric">
                    <div class="kpi-value">$${successRateData.avgTicket.toFixed(2)}</div>
                    <div class="kpi-label">Avg Ticket</div>
                </div>
            </div>
        `;
    }

    generateHeatIndexCard(heatIndexData) {
        const totalScore = heatIndexData.totalScore || 0;
        const healthStatus = heatIndexData.healthStatus || 'Unknown';
        
        const statusColor = {
            'Healthy': '#4CAF50',
            'Moderate': '#FF9800', 
            'Warning': '#FF5722',
            'Critical': '#F44336'
        }[healthStatus] || '#9E9E9E';
        
        document.getElementById('heatIndexCard').innerHTML = `
            <div class="kpi-main">
                <h2 style="color: ${statusColor}">${totalScore}/100</h2>
                <p>Payment Health Heat Index</p>
                <p style="font-size: 1rem; margin-top: 5px; color: ${statusColor}; font-weight: bold;">${healthStatus}</p>
            </div>
            <div class="kpi-metrics">
                <div class="kpi-metric">
                    <div class="kpi-value">${heatIndexData.unusualFailuresScore}/25</div>
                    <div class="kpi-label">Unusual Failures</div>
                </div>
                <div class="kpi-metric">
                    <div class="kpi-value">${heatIndexData.settlementDelayScore}/25</div>
                    <div class="kpi-label">Settlement Delays</div>
                </div>
                <div class="kpi-metric">
                    <div class="kpi-value">${heatIndexData.highRiskCardScore}/25</div>
                    <div class="kpi-label">High-Risk Cards</div>
                </div>
                <div class="kpi-metric">
                    <div class="kpi-value">${heatIndexData.refundSpikeScore}/25</div>
                    <div class="kpi-label">Refund Spikes</div>
                </div>
            </div>
        `;
    }

    generateFunnelChart(funnelMetrics) {
        if (!funnelMetrics) return;
        
        Plotly.newPlot('funnelChart', [{
            type: 'funnel',
            y: ['Initiated', 'Authorized', 'Captured', 'Settled', 'Refunded'],
            x: [funnelMetrics.initiated, funnelMetrics.authorized, funnelMetrics.captured, funnelMetrics.submittedForSettlement, funnelMetrics.cancelledOrRefunded],
            marker: { color: ['#4facfe', '#00f2fe', '#96ceb4', '#feca57', '#ff6b6b'] }
        }], {
            title: 'Transaction Funnel',
            margin: { t: 40, l: 80, r: 20, b: 40 }
        });
    }
    
    generateHourlyTrend(hourlyTrends) {
        if (!hourlyTrends || hourlyTrends.length === 0) return;
        
        const hours = hourlyTrends.map(h => h.hour);
        const rates = hourlyTrends.map(h => h.successRate);
        
        Plotly.newPlot('successTrend', [{
            x: hours,
            y: rates,
            type: 'scatter',
            mode: 'lines+markers',
            line: { color: '#4facfe', width: 3 },
            marker: { size: 6, color: '#00f2fe' }
        }], {
            title: 'Hourly Success Rate Trend',
            xaxis: { title: 'Hour of Day' },
            yaxis: { title: 'Success Rate (%)', range: [0, 100] },
            margin: { t: 40, l: 60, r: 20, b: 40 }
        });
    }

    generatePaymentMethodChart(paymentMethodRates) {
        if (!paymentMethodRates || paymentMethodRates.length === 0) return;
        
        const methods = paymentMethodRates.map(m => m.paymentMethod);
        const successCounts = paymentMethodRates.map(m => m.successCount);
        const failureCounts = paymentMethodRates.map(m => m.failureCount);
        
        Plotly.newPlot('paymentMethodChart', [{
            x: methods,
            y: successCounts,
            name: 'Success',
            type: 'bar',
            marker: { color: '#96ceb4' }
        }, {
            x: methods,
            y: failureCounts,
            name: 'Failure',
            type: 'bar',
            marker: { color: '#ff6b6b' }
        }], {
            title: 'Payment Method Performance',
            xaxis: { title: 'Payment Method' },
            yaxis: { title: 'Count' },
            barmode: 'stack',
            margin: { t: 40, l: 60, r: 20, b: 60 }
        });
    }

    generateLocationHeatmap(locationRates) {
        if (!locationRates || locationRates.length === 0) return;
        
        const locations = locationRates.map(l => l.locationId);
        const failureRates = locationRates.map(l => (100 - l.successRate).toFixed(1));
        
        Plotly.newPlot('locationHeatmap', [{
            z: [failureRates],
            x: locations,
            y: ['Failure Rate'],
            type: 'heatmap',
            colorscale: [[0, '#96ceb4'], [0.5, '#feca57'], [1, '#ff6b6b']],
            hovertemplate: 'Location: %{x}<br>Failure Rate: %{z}%<extra></extra>'
        }], {
            title: 'Location Failure Rates',
            xaxis: { title: 'Location ID' },
            yaxis: { showticklabels: false },
            margin: { t: 40, l: 60, r: 20, b: 80 }
        });
    }

    analyzeHeatIndex(heatIndexData) {
        const totalScore = heatIndexData.totalScore || 0;
        
        if (totalScore >= 80) {
            this.addInsight(`üö® CRITICAL: Heat Index at ${totalScore}/100 - Immediate attention required`, 'error');
        } else if (totalScore >= 60) {
            this.addInsight(`‚ö†Ô∏è WARNING: Heat Index at ${totalScore}/100 - Monitor closely`, 'warning');
        } else if (totalScore >= 40) {
            this.addInsight(`üü° MODERATE: Heat Index at ${totalScore}/100 - Some issues detected`, 'warning');
        } else {
            this.addInsight(`‚úÖ HEALTHY: Heat Index at ${totalScore}/100 - System operating normally`, 'live');
        }
        
        // Analyze individual components
        if (heatIndexData.unusualFailuresScore > 15) {
            this.addInsight(`üìà Unusual failure spike detected (${heatIndexData.unusualFailuresScore}/25)`, 'warning');
        }
        if (heatIndexData.settlementDelayScore > 15) {
            this.addInsight(`‚è∞ Settlement delays above normal (${heatIndexData.settlementDelayScore}/25)`, 'warning');
        }
        if (heatIndexData.highRiskCardScore > 15) {
            this.addInsight(`üõ°Ô∏è High-risk card activity detected (${heatIndexData.highRiskCardScore}/25)`, 'warning');
        }
        if (heatIndexData.refundSpikeScore > 15) {
            this.addInsight(`üîÑ Refund/chargeback spike detected (${heatIndexData.refundSpikeScore}/25)`, 'warning');
        }
    }

    addInsight(message, type = 'live') {
        const timestamp = new Date().toLocaleTimeString();
        this.insights.unshift({ message, type, timestamp });
        
        if (this.insights.length > 10) {
            this.insights = this.insights.slice(0, 10);
        }
        
        this.updateInsightsDisplay();
    }
    
    updateInsightsDisplay() {
        const container = document.getElementById('insightsList');
        container.innerHTML = this.insights.map(insight => `
            <div class="insight-item">
                <span class="status-indicator status-${insight.type}"></span>
                [${insight.timestamp}] ${insight.message}
            </div>
        `).join('');
    }
}

// Initialize Dashboard Manager
const dashboardManager = new DashboardManager();

// Dashboard is now fully integrated with the GetDashboardData API

</script>
</body>
</html>